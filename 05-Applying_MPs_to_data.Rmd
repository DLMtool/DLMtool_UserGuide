
# (PART\*) Using Fishery Data  {-}

# The Fishery Data Object 

`Data` is an object class in the DLMtool that contains all of the fishery information that can be used by the Management Procedure.  You find the documentation for the `Data` class by typing:
```{r, eval=FALSE}
class?Data
```

You can see from the documentation that the `Data` object, or Fishery Data object, contains many slots, and a lot of information can be stored in this object, including biological parameters, fishery statistics such as time-series of catch, and past management recommendations.


## In the MSE
In the MSE the Fishery Data object is populated with data that is generated by the simulation model.  Here the 'true' data generated by the model is filtered through the Observation Model (using the Observation parameters) and entered into the Fishery Data object to represent typical fisheries data.

The MSE consists of many hundreds of simulations, and because the DLMtool has been designed for parallel processing, the Fishery Data object in the MSE actually consists of hundreds of 'versions' of the simulated fishery data. 

The first argument for all Management Procedure functions is `x`, which is the position in the `Data` object that refers to the data corresponding that particular iteration. In the MSE, the value of `x` goes from 1 to the total number of simulations (`nsim`).

The second argument for all Management Procedures in the DLMtool is the `Data` object.

For example, the arguments to the `AvC` MP are:
```{r}
args(AvC)
```

The [Developing Custom Management Procedures] section describes the arguments and internal workings of the Management Procedure functions in more detail. 

## Application of Management Procedures Using Real Fisheries Data 
In contrast to the MSE, in the real world application of a Management Procedure, we only have one version of the fishery data: the data that has been collected from the fishery. 

The Fishery Data object contains all of the fishery information that can be used by a Management Procedure.  By definition, many sources of data are not available in data-limited fisheries, and the Fishery Data object may not be completely populated.  The DLMtool can be used to determine which of the Management Procedures in the Toolkit are available to be used given the data in the Fishery Data object, which methods cannot be used, and what data are required to make these methods available.  


# Example Data Objects
The DLMtool package has a number of example Fishery Data objects. This can be listed using the `avail` function:
```{r}
avail("Data")
```

```{r, include=FALSE}
ndat <- length(avail("Data"))
```



# Creating Your Own Data Object
DLMtool has a series of functions to make importing data and applying data-limited Management Procedures relatively straightforward. 

There are two approaches: 

1. Fill out a .csv data file in excel or a text editor and use a DLMtool function to create a properly formatted `Data` object (class `Data`), or
2. Create a blank `Data` object and populate it in R. 

## Creating a Data File in Excel
```{r, include=FALSE}
if (!dir.exists("ExampleData")) dir.create("ExampleData")
DataInit("MyData", dir="ExampleData", overwrite = TRUE)
```

Probably the easiest way to get your data into the DLMtool is to populate a data table in an Excel workbook. 

You can create a Data workbook using the `DataInit` function, for example:
```{r, eval=FALSE}
DataInit("MyData")
```
This will create a file 'MyData.xlsx' in your current working directory, which can be populate with your fishery data.

Remember, to see the help documentation for information on the slots in the Data object:
```{r, eval=FALSE}
?class("Data")
```

You do not have to enter data for every line of the data file, if data are not available simply put an 'NA' next to any given field. 

## Importing the Data object
Once populated, the Excel Data file can be imported into R:
```{r, eval=FALSE}
MyData <- XL2Data('MyData')
```
In this case we get an error because the Data file is empty: we haven't populated it with an data yet. Luckily for us, DLMtool includes several example Data files.

## Example Fishery Data Files
```{r, include=FALSE}
file.copy(file.path(DLMDataDir(),"China_rockfish.csv"), "ExampleData")
```

One example Data file is the China rockfish. You can [download](docs/ExampleData/China_rockfish.csv) this Data file to your current working directory and import into R:

```{r, eval=FALSE}
China_rockfish <- XL2Data("China_rockfish.csv")
```

The CSV files for the other example Fishery Data objects are also included in the DLMtool package.  To find the location where these files are located on your machine, use the `DLMDataDir` function:
```{r}
DLMDataDir()
```

We can then load one of the example CSV files using the `XL2Data` function:

```{r}
China_rockfish2 <- XL2Data("China_rockfish.csv", dir=DLMDataDir())
```
or the `new` function:

```{r}
China_rockfish2 <- new("Data", file.path(DLMDataDir(),"China_rockfish.csv"))
```

Alternatively, you can navigate to the data directory (`DLMDataDir()`) on your machine and examine the contents and structure of the CSV data files in MS Excel or other software.

## Populating a Data Object in R
You can create a blank `Data` object and fill the slots directly in R. For example:

```{r}
Madeup <- new('Data')                             #  Create a blank DLM object
Madeup@Name <- 'Test'                                 #  Name it
Madeup@Cat <- matrix(20:11*rlnorm(10,0,0.2),nrow=1)   #  Generate fake catch data
Madeup@Units <- "Million metric tonnes"               #  State units of catch
Madeup@AvC <- mean(Madeup@Cat)                        #  Average catches for time t (DCAC)
Madeup@t <- ncol(Madeup@Cat)                          #  No. yrs for Av. catch (DCAC)
Madeup@Dt <- 0.5                                      #  Depletion over time t (DCAC)
Madeup@Dep <- 0.5                                     #  Depletion relative to unfished 
Madeup@vbK <- 0.2                                     #  VB maximum growth rate
Madeup@vbt0 <- (-0.5)                                 #  VB theoretical age at zero length
Madeup@vbLinf <- 200                                  #  VB maximum length
Madeup@Mort <- 0.1                                    #  Natural mortality rate
Madeup@Abun <- 200                                    #  Current abundance
Madeup@FMSY_M <- 0.75                                 #  Ratio of FMSY/M
Madeup@L50 <- 100                                     #  Length at 50% maturity
Madeup@L95 <- 120                                     #  Length at 95% maturity
Madeup@BMSY_B0 <- 0.35                                #  BMSY relative to unfished
```

# Plotting Data Objects
A generic summary function is available to visualize the data in a `Data` object. By default the `summary` function waits for user input before displaying the next plot, this option can be switched off using `wait=FALSE`:

```{r, fig.width=7, fig.height=3.5}
summary(Cobia, wait=FALSE)
```


# Determining Feasible and Available Management Procedures 

Although all management procedures can be tested in the simulation, it is often the case that not all MPs can actually be applied in a fishery. This can happen for two reasons:

1. Insufficient data exists to use an MP, for example, a MP may use catch-at-age data which does not exist for the fishery
2. Management constraints such as issues with enforcement or legal requirements may mean some management options are not possible.

Management procedures which can be applied given the current fishery data are referred to as *Available*. 

Management procedures that return management recommendations that are, at least in theory, applicable to the fishery are referred to as *Feasible*.

DLMtool has functions to identify MPs that are *Available* and *Feasible*, and also provides information for what additional data are required to allow *Not Available* MPs to be used.

## Feasible MPs
The `Fease` function can be used to determine which MPs are *Feasible*. 

For example, if only TAC management is feasible in a fishery, the feasible MPs are:
```{r}
Fease(TAC=TRUE, TAE=FALSE, SL=FALSE, Spatial=FALSE)
```
We can confirm that all of these MPs are output controls (return a TAC) by using the `MPtype` function:
```{r}
feaseMPs <- Fease(TAC=TRUE, TAE=FALSE, SL=FALSE, Spatial=FALSE)
MPtype(feaseMPs)
```

If a `Data` object is provided to `Fease`, the function will return the names of MPs that are both feasible in terms of management methods, and available in terms of the fishery data:
```{r}
feaseMPs <- Fease(Atlantic_mackerel, TAC=FALSE, TAE=TRUE, SL=TRUE, Spatial=FALSE)
MPtype(feaseMPs)
```


## Available MPs
The `Can` function generates a list of the MPs that are available to be applied to the Data object:
```{r Can}
Can(Atlantic_mackerel)
```

If all management methods are feasible, the list of MPs returned by the `Can` function will be the same as those returned by the `Fease` function when the `Data` object is provided.

## Unavailable MPs
The `Cant` function displays a list of the MPs that cannot be applied to the Data object together with the reason why:
```{r Cant}
Cant(Atlantic_mackerel)
```


# Applying Management Procedures

The `runMP` function can be used to apply a MP to a Data object. For example, to apply the `AvC` method:
```{r}
runMP(Atlantic_mackerel, "AvC", reps=1000)
```

The `runMP` prints out the MP recommendations to the console. In the case of a TAC, where multiple repititions where (see `reps` = 1000 above) used the `runMP` function prints the median TAC recommendation.

Although it only displays a summary, `runMP` invisibly returns the Data object with the TAC slot populated:

```{r}
Recs <- runMP(Atlantic_mackerel, "AvC")
hist(Recs@TAC)
```

`runMP` can be used to run several MPs:
```{r}
runMP(Atlantic_mackerel, c("AvC", "AvC_MLL"))
```

Or all available MPs:
```{r}
Atlantic_mackerel <- runMP(Atlantic_mackerel, reps=1000)
```

The TAC recommendations from each Output control can be plotted:

```{r, fig.height=7, fig.width=6}
boxplot(Atlantic_mackerel)
```


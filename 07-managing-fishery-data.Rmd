# Managing Fishery Data
## The Fishery Data Object (`DLM_data`)
The second argument for all Management Procedures in the DLMtool is something called `DLM_data`.
```{r, message=FALSE, warning=FALSE, include=FALSE}
library(DLMtool) # only needed for building individual chapter of user guide
for(i in 1:length(DLMdat)) assign(DLMdat[[i]]@Name, DLMdat[[i]])
```

`DLM_data` is an object class in the DLMtool that contains all of the fishery information that can be used by the Management Procedure.  You find the documentation for the `DLM_data` class by typing:
```{r, eval=FALSE}
class?DLM_data
```

You can see from the documentation that the `DLM_data` object, or Fishery Data object, contains many slots, and a lot of information can be stored in this object, including biological parameters, fishery statistics such as time-series of catch, and past management recommendations.

### In the MSE
In the MSE the Fishery Data object is populated with data that is generated by the simulation model.  Here the 'true' data generated by the model is filtered through the Observation Model (using the Observation parameters) and entered into the Fishery Data object to represent typical fisheries data.

The MSE consists of many hundreds of simulations, and because the DLMtool has been designed for parallel processing, the Fishery Data object in the MSE actually consists of hundreds of 'versions' of the simulated fishery data. 

The first argument for all Management Procedure functions is `x`, which is the position in the `DLM_data` object that refers to the data corresponding that particular iteration. In the MSE, the value of `x` goes from 1 to the total number of simulations (`nsim`).

### Application of Management Procedures Using Real Fisheries Data 
In contrast to the MSE, in the real world application of a Management Procedure, we only have one version of the fishery data: the data that has been collected from the fishery. 

The Fishery Data object contains all of the fishery information that can be used by a Management Procedure.  By definition, many sources of data are not available in data-limited fisheries, and the Fishery Data object may not be completely populated.  The DLMtool can be used to determine which of the Management Procedures in the Toolkit are available to be used given the data in the Fishery Data object, which methods cannot be used, and what data are required to make these methods available.  More information on applying Management Procedures to fishery data can be found in the [Application of Management Procedure] section.

## Example `DLM_data` Objects
The DLMtool package has a number of example Fishery Data objects. This can be listed using the `avail` function:
```{r}
avail("DLM_data")
```

```{r, include=FALSE}
ndat <- length(avail("DLM_data"))
```

This shows us that there is `r ndat` example Fishery Data objects in the DLMtool.

## Creating Your Own `DLM_data` Object
DLMtool has a series of functions to make importing data and applying data-limited Management Procedures relatively straightforward. 

There are two approaches: 

1. Fill out a .csv data file in excel or a text editor and use a DLMtool function to create a properly formatted `DLM_data` object (class `DLM_data`), or
2. Create a blank `DLM_data` object and populate it in R. 

### Creating a CSV Data File
Probably the easiest way to get your data into the DLMtool is to populate a .csv data file. These files have a line for each slot of the `DLM_data` object:
```{r]}
slotNames('DLM_data')
```

You do not have to enter data for every line of the data file, if data are not available simply put an 'NA' next to any given field. 

#### Example Fishery Data CSV Files
There are also CSV files for these example Fishery Data objects that are included in the DLMtool package.  To find the location where these files are located on your machine, use the `DLMDataDir` function:
```{r}
DLMDataDir()
```

We can then load one of the example CSV files using the `new` function:

```{r}
China_rockfish2 <- new("DLM_data", paste0(DLMDataDir(),"China_rockfish.csv"))
```

Alternatively, you can navigate to the data directory on your machine and examine the contents and structure of the CSV data files in MS Excel or other software.

### Populating a `DLM_data` Object in R
Alternatively you can create a blank `DLM_data` object and fill the slots directly in R. For example:

```{r}
Madeup <- new('DLM_data')                             #  Create a blank DLM object
Madeup@Name <- 'Test'                                 #  Name it
Madeup@Cat <- matrix(20:11*rlnorm(10,0,0.2),nrow=1)   #  Generate fake catch data
Madeup@Units <- "Million metric tonnes"               #  State units of catch
Madeup@AvC <- mean(Madeup@Cat)                        #  Average catches for time t (DCAC)
Madeup@t <- ncol(Madeup@Cat)                          #  No. yrs for Av. catch (DCAC)
Madeup@Dt <- 0.5                                      #  Depletion over time t (DCAC)
Madeup@Dep <- 0.5                                     #  Depletion relative to unfished 
Madeup@vbK <- 0.2                                     #  VB maximum growth rate
Madeup@vbt0 <- (-0.5)                                 #  VB theoretical age at zero length
Madeup@vbLinf <- 200                                  #  VB maximum length
Madeup@Mort <- 0.1                                    #  Natural mortality rate
Madeup@Abun <- 200                                    #  Current abundance
Madeup@FMSY_M <- 0.75                                 #  Ratio of FMSY/M
Madeup@L50 <- 100                                     #  Length at 50% maturity
Madeup@L95 <- 120                                     #  Length at 95% maturity
Madeup@BMSY_B0 <- 0.35                                #  BMSY relative to unfished
```

## Working With `DLM_data` Objects
A generic summary function is available to visualize the data in a `DLM_data` object:
```{r, fig.width=7, fig.height=3.5}
summary(Atlantic_mackerel)
```

You can see what Management Procedures can and can't be applied given your data and also what data are needed to get them working: 

```{r}
Can(Atlantic_mackerel)
Cant(Atlantic_mackerel)
Needed(Atlantic_mackerel)
```

## Applying Management Procedures

### `DLM_input` Methods
Spatial and length-vulnerability Management Procedures (class `DLM_input`) can be MSE tested but are often a management recommendation in themselves (e.g., setting a static size limit or closing a spatial area).  Other input control methods are dynamic and respond to trends in different indicators in the data.

The `Input` function can be used to apply an input control method. For example, here we apply the `matlenlim` method to the `Atlantic_mackerel` data object:

```{r}
Input(Atlantic_mackerel, "matlenlim")
```

The resulting recommendation is a size limit around 90 cm.  There is no upper slot limit specified, and the fishing effort and spatial areas open to fishing remained unchanged.

### `DLM_output` Methods
The `TAC` function can be used to calculate the recommended TAC for output controls Management Procedures. Here we apply the `DCAC` method, with 1,000 repetitions, to the `Atlantic_mackerel` data object:

```{r, eval=TRUE}
Atlantic_mackerel <- TAC(Atlantic_mackerel, MPs="DCAC", reps=1000)
```

The resulting distribution of the recommended TAC can be plotted using the `plot` function:
```{r, fig.width=6, fig.height=8}
plot(Atlantic_mackerel)
```

We can also apply all the out control methods that can be run with the Fishery Data object to compare the resulting recommendations:

```{r}
Atlantic_mackerel <- TAC(Atlantic_mackerel)
plot(Atlantic_mackerel)
```

Alternatively, we can use `boxplot`, a generic function that calls the `boxplot.DLM_data` function, to display the distribution of recommended TACs and report the statistics (median and standard deviation):
```{r, fig.height=7, fig.width=6}
boxplot(Atlantic_mackerel)
```
